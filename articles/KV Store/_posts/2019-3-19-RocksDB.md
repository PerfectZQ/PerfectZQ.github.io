---
layout: post
title: RocksDB
tag: TiDB
---

## 常见 KV Store
常见kv存储有
* 基于内存的 redis
* 基于单机磁盘的 leveldb、rocksdb
* 分布式(超过 TB 级别的) cassandra、hbase

## RocksDB
* [RocksDB](https://github.com/facebook/rocksdb/wiki)
* [RocksDB 中文网](https://rocksdb.org.cn/doc.html)
* [RocksDB 引擎: 5分钟全面了解其原理](https://sdk.cn/news/6686)

## 安装
rocksdb 是 c++ 写的，由于官方没有提供对应平台的二进制库，不同平台编译的类库是不通用的，所以需要自己去相应的平台编译使用。如果使用 rocksdbjava 这个问题就好很多，但是 java api 总是落后于 c++ 版本的。

在安装 rocksdb 之前，需要理解一下什么是嵌入式的 kv-store。对于非嵌入式的 kv-store，比如 redis，想使用 redis 就需要先安装 redis-server，然后通过 redis-client 对数据进行读写。而对于嵌入式的 kv-store 来讲，是没有具体服务端的，直接用代码操作数据存储，也就是说只需要在你的项目中引入 rocksdb 的相关依赖(java 在 maven 中添加依赖)，就可以在开发了。

### C++
[RocksDB Install](https://github.com/facebook/rocksdb/blob/master/INSTALL.md)

```shell
# 如果 ./configure 时报错 configure: error: C++ compiler cannot create executables，这种是缺少 c++ 组件
$ yum install -y gcc gcc-c++ gcc-g77 

# Install gflags
$ git clone https://github.com/gflags/gflags.git
$ cd gflags
$ git checkout v2.0
$ ./configure && make && sudo make install

# Install snappy:
$ sudo yum install -y snappy snappy-devel

# Install zlib:
$ sudo yum install -y zlib zlib-devel

# Install bzip2:
$ sudo yum install -y bzip2 bzip2-devel

# Install lz4:
$ sudo yum install -y lz4-devel

# Install ASAN (optional for debugging):
$ sudo yum install -y libasan

# Install zstandard:
$ wget https://github.com/facebook/zstd/archive/v1.1.3.tar.gz
$ mv v1.1.3.tar.gz zstd-1.1.3.tar.gz
$ tar zxvf zstd-1.1.3.tar.gz
$ cd zstd-1.1.3
$ make && sudo make install

# Install rocksdb
$ git clone https://github.com/facebook/rocksdb.git

$ cd rocksdb

# 编译静态库，release mode，获得librocksdb.a
$ make static_lib

# 编译动态库，release mode，获得librocksdb.so
$ make shared_lib

$ cp librocksdb.a /usr/lib
$ cp -r include/ /usr/include
$ cp librocksdb.so /usr/lib
$ sudo ldconfig
```

### Java
[RocksJava Basics](https://github.com/facebook/rocksdb/wiki/RocksJava-Basics)

```xml
<dependency>
    <groupId>org.rocksdb</groupId>
    <artifactId>rocksdbjni</artifactId>
    <version>5.17.2</version>
</dependency>
```

## 管理工具
使用`ldb`和`sst_dump`来管理 rocksdb，在安装了上述 c++ 依赖之后
```shell
# Linux
$ cd rocksdb
$ make ldb sst_dump
$ cp ldb /usr/local/bin/
$ cp sst_dump /usr/local/bin/

# OSX 
$ brew install rocksdb
# 对应的命令分别为
$ rocksdb_ldb
$ rocksdb_sst_dump
```

关于`ldb`和`sst_dump`使用方法，可以参考官方文档[https://github.com/facebook/rocksdb/wiki/Administration-and-Data-Access-Tool](https://github.com/facebook/rocksdb/wiki/Administration-and-Data-Access-Tool)

### examples
#### 查看所有数据库的所有 keys
```shell
#!/bin/bash

export DATA_PATH=/hadoop/rockfs/data
export DB_INSTANCES=$(ls /hadoop/rockfs/data)

for i in $DB_INSTANCES; do 
  ldb --db=$DATA_PATH/$i/ scan 2>/dev/null; 
done
```

#### 查看 SST file properties
```shell
# 注意 --file 需要指定绝对路径
$ sst_dump --file=$DATA_PATH/test --show_properties
from [] to []
Process /hadoop/rockfs/data/0006.sst
Sst file format: block-based
Table Properties:
------------------------------
  # data blocks: 26541
  # entries: 2283572
  raw key size: 264639191
  raw average key size: 115.888262
  raw value size: 26378342
  raw average value size: 11.551351
  data block size: 67110160
  index block size: 3620969
  filter block size: 0
  (estimated) table size: 70731129
  filter policy name: N/A
  # deleted keys: 571272
  
# 如果出现 sst_dump: error while loading shared libraries: libgflags.so.2: cannot open shared object file: No such file or directory
$ find / -name libgflags.so.2
/root/gflags/.libs/libgflags.so.2
/usr/local/lib/libgflags.so.2
# 可以看出依赖已经下载到了，只是没有被找到，手动指定下依赖库
$ vim /etc/ld.so.conf.d/usr-libs.conf
/usr/local/lib
$ sudo ldconfig
```

### 升级 gcc 到 8.1
[http://mirror.hust.edu.cn/gnu](http://mirror.hust.edu.cn/gnu)
下载`gmp-5.1.1.tar.bz2`、`mpfr-3.1.5.tar.bz2`、`mpc-1.1.0.tar.gz`、`gcc-8.0.1.tar.gz`

```shell
$ yum install -y m4

$ tar -xvf gmp-5.1.1.tar.bz2
$ cd gmp-5.1.1
$ ./configure --prefix=/usr/local/gmp-5.1.1 && make
$ make install

$ tar -xvf mpfr-3.1.5.tar.bz2
$ cd mpfr-3.1.5
$ ./configure --prefix=/usr/local/mpfr-3.1.5 --with-gmp=/usr/local/gmp-5.1.1 && make
$ make install

$ tar -zxvf mpc-1.1.0.tar.gz
$ cd mpc-1.1.0
$ ./configure --prefix=/usr/local/mpc-1.1.0 --with-gmp=/usr/local/gmp-5.1.1 --with-mpfr=/usr/local/mpfr-3.1.5 && make
$ make install

$ tar -zxvf gcc-8.0.1.tar.gz
$ export LD_LIBRARY_PATH=/usr/local/mpc-1.1.0/lib:/usr/local/gmp-5.1.1/lib:/usr/local/mpfr-3.1.5/lib:$LD_LIBRARY_PATH
$ cd gcc-8.0.1
$ ./configure --prefix=/usr/local/gcc-8.0.1 --enable-threads=posix --disable-checking --disable-multilib --enable-languages=c,c++ --with-gmp=/usr/local/gmp-5.1.1 --with-mpfr=/usr/local/mpfr-3.1.5 --with-mpc=/usr/local/mpc-1.1.0 && make
$ make install
```

## Terminology
[Terminology](https://github.com/facebook/rocksdb/wiki/Terminology)

### 存储类型
RocksDB 有三个非常重要的结构`memtable`、`sstfile`和`logfile`。`memtable`顾名思义是一个内存中的数据结构，当新的数据被写入时会被插入到`memtable`，通过选择开启`WAL`可以在写入之前先将数据操作写入`logfile`来保证内存写入数据的不丢失。`logfile`是一个磁盘上的顺序写入的日志文件。`memtable`有分为两种，一种叫做`active memtable`，另一种叫做`immutable memtable`，当`active memtable`被写满就会变成`immutable memtable`，刷入到`sstfile`，成功保存到磁盘之后就可以将内存中的数据清空掉了。[The format of a default sstfile](https://github.com/facebook/rocksdb/wiki/Rocksdb-BlockBasedTable-Format)。

### 

## RocksDB Tuning
* [RocksDB-Tuning-Guide](https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide)
* [RocksDB参数调优](https://xiking.win/2018/12/05/rocksdb-tuning/)

### Amplification factors (放大因素)
其实对数据库系统的调优很大一部分工作是在**写放大**、**读放大**和**空间放大**这三个放大因子之间做取舍。

* **写放大**: 平均写入`1`个字节，引擎中在数据的声明周期内实际会写入`n`个字节(比如`compaction`操作会将数据合并压缩后再写一遍)，其写放大率是`n`。也就是如果在业务方写入速度是`10mb/s`，在引擎端或者操作系统层面能观察到的数据写入速度是`30mb/s`，这时，系统的写放大率就是`3`。写放大过大会制约系统的实际吞吐。并且对于SSD来说，越大的写放大，也会导致SSD寿命缩短。
* **读放大**: 一个小的读请求，系统所需要读去`n`个页面来完成查询，其读放大率是`n`。逻辑上的读操作可能会命中引擎内部的`cache`或者文件系统`cache`，命中不了`cache`就会进行实际的磁盘IO，命中`cache`的读取操作的代价虽然很低，但是也会消耗 cpu。
* **空间放大**: 就是平均存储`1`个字节的数据，在存储引擎内部所占用的磁盘空间`n`个字节，其空间放大是`n`。比如写入`10mb`的数据，大小在磁盘上实际占用了`100mb`，这是空间放大率就是`10`。空间放大和写放大在调优的时候往往是互斥的，空间放大越大，那么数据就不需要频繁的`compaction`，其写放大就会降低；如果空间放大率设置的小，那么数据就需要频繁的`compaction`来释放存储空间，导致写放大增大。

### Parallelism options
LSM 架构的引擎，后台主要有两种线程，`flush`和`compaction`。在RocksDB中，两种线程有不同的优先级，`flush`优先级高，`compaction`优先级低。为了充分利用多核，RocksDB中的两种线程可以配置线程数。
* `max_background_flushes`: 是后台`memtable`dump 成`sstable`的并发线程数。默认是`1`，但是当使用多个`column family`时，内部会存在多个`memtable`，可能会同时发生`flush`，如果线程是`1`，在写入量大的情况下，可能会导致`flush`不及时，出现无法写入的情况。
* `max_background_compactions`: 是后台`sstable flush`的线程数量，因为一般 RocksDB 会有多个`level`，涉及多个`sstable`文件，并发`compaction`会加快`compaction`的速度，但是如果`compaction`过慢，达到`soft_pending_compaction_bytes_limit`会发生阻塞，达到`hard_pending_compaction_bytes`会停写。
