---
layout: post
title: 集群搭建
tag: ElasticSearch
---

## 目录
* TOC
{:toc}

## Elastic Stack and Product Introduction
[Elastic Stack and Product 说明链接](https://www.elastic.co/cn/products)
[Elastic Stack and Product 文档链接](https://www.elastic.co/guide/index.html)

### ELK简介
* **E:** ElasticSearch 基于Luence构建的开源、分布式、RESTful接口全文搜索引擎，它还是一个分布式文档数据库，其中的每个字段都是被索引的数据，并且可被搜索，能够扩展到数以百计的服务器存储以及处理PB级别的数据。
* **L:** Logicstash 是一个灵活、开源的数据收集、处理、传输的工具。它可以处理日志、事件、非结构化的数据，并把他们输出出来，比如输出到ElasticSearch中
* **K:** Kibana 能够可视化 Elasticsearch 中的数据并操作 Elastic Stack，例如，雨水会对季度数据造成怎样的影响。

　　业界一般将ELK组合专门用来处理、存储、展示日志。

## ElasticSearch
* **一本书的链接(中文的哦)：** [《Elasticsearch 权威指南》](https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html)
* **安装版本：** elasticsearch-6.0.0 
* **操作系统：** CenOS 6.7

### 安装与配置
```shell
tar -zxvf elasticsearch-6.0.0.tar.gz -C /opt/elasticsearch/
cd /opt/elasticsearch/elasticsearch-6.0.0/config/
# 其中包含三个文件 elasticsearch.yml  jvm.options  log4j2.properties
vim elasticsearch.yml 
# 修改如下配置
# 索引存储位置
path.data: /opt/elasticsearch/data
# 日志存储位置
path.logs: /opt/elasticsearch/logs
# 内存分配模式
bootstrap.memory_lock: false
bootstrap.system_call_filter: false
# 绑定IP
network.host: 10.4.121.79
# 端口号
http.port: 9200
# 当删除索引时，必须指定索引名称
action.destructive_requires_name: true
```

　　修改完配置文件之后，`cd /opt/elasticsearch/elasticsearch-6.0.0/bin`，然后`./elasticsearch`

　　如果启动成功了，在浏览器访问`http:10.4.121.79:9200`可以看到
```consle
{
  "name" : "irLY0__",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "djFq3wkhQz-GVOIJckvIgw",
  "version" : {
    "number" : "6.0.0",
    "build_hash" : "8f0685b",
    "build_date" : "2017-11-10T18:41:22.859Z",
    "build_snapshot" : false,
    "lucene_version" : "7.0.1",
    "minimum_wire_compatibility_version" : "5.6.0",
    "minimum_index_compatibility_version" : "5.0.0"
  },
  "tagline" : "You Know, for Search"
}
```
### 启动异常
```console
[2017-11-20T11:02:27,267][WARN ][o.e.b.JNANatives         ] unable to install syscall filter: 
java.lang.UnsupportedOperationException: seccomp unavailable: CONFIG_SECCOMP not compiled into kernel, CONFIG_SECCOMP and CONFIG_SECCOMP_FILTER are needed
	at org.elasticsearch.bootstrap.SystemCallFilter.linuxImpl(SystemCallFilter.java:341) ~[elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.SystemCallFilter.init(SystemCallFilter.java:616) ~[elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.JNANatives.tryInstallSystemCallFilter(JNANatives.java:258) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.Natives.tryInstallSystemCallFilter(Natives.java:113) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.Bootstrap.initializeNatives(Bootstrap.java:109) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:171) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:322) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:130) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:121) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:69) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:134) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.cli.Command.main(Command.java:90) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:92) [elasticsearch-6.0.0.jar:6.0.0]
	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:85) [elasticsearch-6.0.0.jar:6.0.0]
[2017-11-20T11:02:27,544][INFO ][o.e.n.Node               ] [node-1] initializing ...
[2017-11-20T11:02:27,730][INFO ][o.e.e.NodeEnvironment    ] [node-1] using [1] data paths, mounts [[/ (rootfs)]], net usable_space [22.8gb], net total_space [49gb], types [rootfs]
[2017-11-20T11:02:27,731][INFO ][o.e.e.NodeEnvironment    ] [node-1] heap size [990.7mb], compressed ordinary object pointers [true]
[2017-11-20T11:02:27,734][INFO ][o.e.n.Node               ] [node-1] node name [node-1], node ID [irLY0__cTcSCke-RWHyl3w]
[2017-11-20T11:02:27,734][INFO ][o.e.n.Node               ] [node-1] version[6.0.0], pid[1644], build[8f0685b/2017-11-10T18:41:22.859Z], OS[Linux/2.6.32-573.el6.x86_64/amd64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_111/25.111-b14]
[2017-11-20T11:02:27,735][INFO ][o.e.n.Node               ] [node-1] JVM arguments [-Xms1g, -Xmx1g, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -XX:-OmitStackTraceInFastThrow, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -XX:+HeapDumpOnOutOfMemoryError, -Des.path.home=/opt/elasticsearch/elasticsearch-6.0.0, -Des.path.conf=/opt/elasticsearch/elasticsearch-6.0.0/config]
[2017-11-20T11:02:29,299][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [aggs-matrix-stats]
[2017-11-20T11:02:29,300][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [analysis-common]
[2017-11-20T11:02:29,300][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [ingest-common]
[2017-11-20T11:02:29,300][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [lang-expression]
[2017-11-20T11:02:29,300][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [lang-mustache]
[2017-11-20T11:02:29,300][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [lang-painless]
[2017-11-20T11:02:29,301][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [parent-join]
[2017-11-20T11:02:29,301][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [percolator]
[2017-11-20T11:02:29,301][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [reindex]
[2017-11-20T11:02:29,301][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [repository-url]
[2017-11-20T11:02:29,301][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [transport-netty4]
[2017-11-20T11:02:29,301][INFO ][o.e.p.PluginsService     ] [node-1] loaded module [tribe]
[2017-11-20T11:02:29,302][INFO ][o.e.p.PluginsService     ] [node-1] no plugins loaded
[2017-11-20T11:02:31,866][INFO ][o.e.d.DiscoveryModule    ] [node-1] using discovery type [zen]
[2017-11-20T11:02:32,984][INFO ][o.e.n.Node               ] [node-1] initialized
[2017-11-20T11:02:32,984][INFO ][o.e.n.Node               ] [node-1] starting ...
[2017-11-20T11:02:33,421][INFO ][o.e.t.TransportService   ] [node-1] publish_address {10.4.121.79:9300}, bound_addresses {10.4.121.79:9300}
[2017-11-20T11:02:33,450][INFO ][o.e.b.BootstrapChecks    ] [node-1] bound or publishing to a non-loopback or non-link-local address, enforcing bootstrap checks
ERROR: [4] bootstrap checks failed
[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]
[2]: max number of threads [1024] for user [elasticsearch] is too low, increase to at least [4096]
[3]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
[4]: system call filters failed to install; check the logs and fix your configuration or disable system call filters at your own risk
[2017-11-20T11:02:33,477][INFO ][o.e.n.Node               ] [node-1] stopping ...
[2017-11-20T11:02:33,547][INFO ][o.e.n.Node               ] [node-1] stopped
[2017-11-20T11:02:33,547][INFO ][o.e.n.Node               ] [node-1] closing ...
[2017-11-20T11:02:33,569][INFO ][o.e.n.Node               ] [node-1] closed
```
　　对于最上面的异常`unable to install syscall filter:`，只是警告(WARN)，使用新的linux版本系统就好了，不处理也没关系。

　　对于Error `[2017-11-20T11:02:33,450][INFO ][o.e.b.BootstrapChecks    ] [node-1] bound or publishing to a non-loopback or non-link-local address, enforcing bootstrap checks ERROR: [4] bootstrap checks failed`，可以看出一共有4个错误。

```shell
# 问题[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]
# 原因: 无法创建本地文件问题，用户最大可创建文件数太小
# 解决方案: 
sudo vim /etc/security/limits.conf
# 添加如下内容: 其中 * 代表Linux所有用户的名称(比如 elasticsearch、oracle、hadoop)
* soft nofile 65536
* hard nofile 131072
* soft nproc 2048
* hard nproc 4096
# 保存、退出当前用户、重新登陆生效

# 问题[2]: max number of threads [1024] for user [elasticsearch] is too low, increase to at least [4096]
# 原因: 无法创建本地线程问题，用户最大可创建线程数太小
# 解决方案: 
sudo vim /etc/security/limits.d/90-nproc.conf 
# 将
* soft nproc 1024
# 修改为
* soft nproc 4096
# 保存、退出当前用户、重新登陆生效

# 问题[3]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
# 原因: 最大虚拟内存太小
# 解决方案: 
sudo vim /etc/sysctl.conf 
# 添加下面配置：
vm.max_map_count=262144
# 然后执行命令：
sudo sysctl -p
# 或者，执行下面的命令
sudo sysctl -w vm.max_map_count=262144

# 问题[4]: system call filters failed to install; check the logs and fix your configuration or disable system call filters at your own risk
# 原因: Centos6不支持SecComp，而ES默认bootstrap.system_call_filter为true进行检测，所以导致检测失败，失败后直接导致ES不能启动。
# 详见: https://github.com/elastic/elasticsearch/issues/22899
# 解决方案:
# 在elasticsearch.yml中新增配置bootstrap.system_call_filter，设为false，注意要在Memory下面:
vim $ES_HOME/config/elasticsearch.yml
bootstrap.memory_lock: false
bootstrap.system_call_filter: false

# 最后，重新启动elasticsearch，即可启动成功。
cd $ES_HOME/bin
# -d, --daemonize  Starts Elasticsearch in the background 
./elasticsearch -d
```
　　以上问题解决后，es启动成功了，但又遇到了新的问题，本地机器无法访问虚拟机的服务，两个原因：
1. 9200被限制为本机访问，需要在es的配置文件elasticsearch.yml中新增配置：`network.bind_host:0.0.0.0`
2. 关闭防火墙

## Kibana
* **产品介绍：** [https://www.elastic.co/cn/products/kibana](https://www.elastic.co/cn/products/kibana)
* **下载地址：** [https://www.elastic.co/cn/downloads/kibana](https://www.elastic.co/cn/downloads/kibana)
* **使用手册：** [https://www.elastic.co/guide/en/kibana/current/index.html](https://www.elastic.co/guide/en/kibana/current/index.html)
* **操作系统：** Windows 10 64位
* **版本：** kibana-6.0.0-windows-x86_64
### Kibana 安装与配置
windows 版本 kibana-6.0.0-windows-x86_64.zip

　　解压之后，进入目录 `D:\kibana-6.0.0-windows-x86_64\config`，修改配置文件`kibana.yml`
```shell
# 指定 kibana server host
server.host: "localhost"
# 指定 kibana server port
server.port: 5601
# es 地址
elasticsearch.url: "http://10.4.121.79:9200"
# 指定 kibana日志文件路径
logging.dest: "logs"
```

　　然后进入目录 `D:\kibana-6.0.0-windows-x86_64\bin`，运行`kibana.bat`

### 使用 Kibana
　　启动成功之后就可以访问 `http://localhost:5601` 了。

　　首次使用的时候，需要添加一个`index pattern`，用来告诉kibana我们需要从es里面搜索哪些索引，当然可以添加多个`index pattern`切换。

## ES Hadoop 
[开发文档链接](https://www.elastic.co/guide/en/elasticsearch/hadoop/current/spark.html)